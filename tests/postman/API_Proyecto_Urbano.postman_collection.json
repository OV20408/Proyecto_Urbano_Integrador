{
	"info": {
		"_postman_id": "auth-tests-2024-11-24",
		"name": "API Proyecto Urbano - Tests Auth",
		"description": "ColecciÃ³n de pruebas para autenticaciÃ³n y WebSocket",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. Health Check",
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}/",
					"host": ["{{baseUrl}}"],
					"path": [""]
				}
			},
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test('Status 200', () => pm.response.to.have.status(200));",
							"pm.test('Tiene websocket', () => pm.response.json().websocket);"
						],
						"type": "text/javascript"
					}
				}
			]
		},
		{
			"name": "2. Registro Exitoso",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const ts = Date.now();",
							"const rand = Math.floor(Math.random() * 10000);",
							"pm.collectionVariables.set('testEmail', `test_${ts}_${rand}@example.com`);",
							"pm.collectionVariables.set('testName', `Test User ${rand}`);",
							"pm.collectionVariables.set('testPassword', 'Test123456!');"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test('Status 201', () => pm.response.to.have.status(201));",
							"pm.test('Retorna user', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json.user).to.have.property('id');",
							"    pm.expect(json.user).to.have.property('email');",
							"});",
							"pm.test('NO retorna password', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json.user).to.not.have.property('password');",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"name\": \"{{testName}}\",\n    \"email\": \"{{testEmail}}\",\n    \"password\": \"{{testPassword}}\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/auth/register",
					"host": ["{{baseUrl}}"],
					"path": ["auth", "register"]
				}
			}
		},
		{
			"name": "3. Registro Email Duplicado",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test('Status 409', () => pm.response.to.have.status(409));",
							"pm.test('Mensaje de error', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json.message).to.include('registrado');",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"name\": \"{{testName}}\",\n    \"email\": \"{{testEmail}}\",\n    \"password\": \"{{testPassword}}\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/auth/register",
					"host": ["{{baseUrl}}"],
					"path": ["auth", "register"]
				}
			}
		},
		{
			"name": "4. Registro Datos Incompletos",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test('Status 400', () => pm.response.to.have.status(400));",
							"pm.test('Mensaje incompleto', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json.message.toLowerCase()).to.include('incompleto');",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"name\": \"Test\",\n    \"email\": \"test@example.com\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/auth/register",
					"host": ["{{baseUrl}}"],
					"path": ["auth", "register"]
				}
			}
		},
		{
			"name": "5. Login Exitoso",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test('Status 200', () => pm.response.to.have.status(200));",
							"pm.test('Retorna token', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json).to.have.property('token');",
							"    pm.expect(json).to.have.property('user');",
							"});",
							"pm.test('Token es JWT', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json.token).to.match(/^[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]+$/);",
							"});",
							"",
							"// Guardar token",
							"const json = pm.response.json();",
							"pm.collectionVariables.set('authToken', json.token);",
							"pm.environment.set('authToken', json.token);",
							"console.log('âœ… Token guardado:', json.token.substring(0, 20) + '...');"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"email\": \"{{testEmail}}\",\n    \"password\": \"{{testPassword}}\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/auth/login",
					"host": ["{{baseUrl}}"],
					"path": ["auth", "login"]
				}
			}
		},
		{
			"name": "6. Login Password Incorrecta",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test('Status 401', () => pm.response.to.have.status(401));",
							"pm.test('Mensaje credenciales invÃ¡lidas', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json.message).to.include('Credenciales invÃ¡lidas');",
							"});",
							"pm.test('NO retorna token', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json).to.not.have.property('token');",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"email\": \"{{testEmail}}\",\n    \"password\": \"PasswordIncorrecta123!\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/auth/login",
					"host": ["{{baseUrl}}"],
					"path": ["auth", "login"]
				}
			}
		},
		{
			"name": "7. Login Usuario No Existe",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test('Status 401', () => pm.response.to.have.status(401));",
							"pm.test('Mensaje de error', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json.message).to.include('Credenciales invÃ¡lidas');",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"email\": \"noexiste999999@example.com\",\n    \"password\": \"Test123!\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/auth/login",
					"host": ["{{baseUrl}}"],
					"path": ["auth", "login"]
				}
			}
		},
		{
			"name": "8. Enviar Mensaje WebSocket",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test('Status 200', () => pm.response.to.have.status(200));",
							"pm.test('Retorna mensaje', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json).to.have.property('mensaje');",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"mensaje\": \"ðŸš¨ Alerta desde Postman: PM2.5 nivel crÃ­tico en Zona Centro\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/mensaje",
					"host": ["{{baseUrl}}"],
					"path": ["mensaje"]
				}
			}
		},
		{
			"name": "9. Obtener Valor Aleatorio",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test('Status 200', () => pm.response.to.have.status(200));",
							"pm.test('Valor entre 0-100', () => {",
							"    const json = pm.response.json();",
							"    pm.expect(json.valor).to.be.a('number');",
							"    pm.expect(json.valor).to.be.at.least(0);",
							"    pm.expect(json.valor).to.be.at.most(100);",
							"});",
							"console.log('âœ… Valor generado:', pm.response.json().valor);"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}/valor",
					"host": ["{{baseUrl}}"],
					"path": ["valor"]
				}
			}
		}
	],
	"variable": [
		{
			"key": "testEmail",
			"value": ""
		},
		{
			"key": "testName",
			"value": ""
		},
		{
			"key": "testPassword",
			"value": ""
		},
		{
			"key": "authToken",
			"value": ""
		}
	]
}
